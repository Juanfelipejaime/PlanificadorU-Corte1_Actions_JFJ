name: Seguridad

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  # ===============================
  # 1) SAST - SEMGREP
  # ===============================
  semgrep:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Semgrep
      uses: returntocorp/semgrep-action@v1

    - name: Run Semgrep scan
      run: |
        semgrep --config=p/ci .

  # ===============================
  # 2) SECRET SCANNING - GITLEAKS
  # ===============================
  gitleaks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Secret scan with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      with:
        args: detect --source . --no-git -v

  # ===============================
  # 3) DAST - OWASP ZAP
  # ===============================
  owasp-zap:
    runs-on: ubuntu-latest
    needs: [semgrep, gitleaks]   # Seguridad completa depende de ambos SAST & Secrets

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------
    # Levantar tu app en localhost
    # ----------------------------
    - name: Run your API locally
      run: |
        pip install -r requirements.txt
        python backend/app.py &
        sleep 10  # esperar que arranque

    # ----------------------------
    # Ejecutar OWASP ZAP contra localhost
    # ----------------------------
    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: "http://localhost:5000"
        fail_on_warnings: false
